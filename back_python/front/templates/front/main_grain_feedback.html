<div class="container page" id="feedback" data-page-root="feedback"  ms-controller="feedback">　
  <nav class="navbar navbar-default  navbar-fixed-top">
    <div  class="row navButton">
        <div  class="col-xs-4 text-left icon">
          <a  href="#!/main/grain">
            <img src="/static/front/img/back.png" style="width:16px;"/>
          </a>
        </div>
        <div class="col-xs-4 text-center">
            <h4 id="title" class="topNavButton" style="color:#995010;font-weight:bold;">打卡</h4>
        </div>
        <div class="col-xs-4 text-right">
          <!-- <a href="#!/main/grain/addchild">
            <i class="fa fa-plus fa-2x active"></i>
          </a> -->
        </div>
    </div>
  </nav>
  <div id="childContent"  class="container-fluid childContent" style="height:600px;overflow-y:scroll">
      <ul class="list-group">
        <li  ms-for="(i,item) in @habits"   class="list-group-item" style="margin:10px;background:#f3e6cd;border-radius:5px;">
          <div class="media" style="margin-top:5px">
            <a  href="#" class="media-left">
                <i ms-attr="{class:@item.icon}"   aria-hidden="true" style="color:#995010;"></i>
            </a>
            <div class="media-body">
                <h5 class="media-heading" style="margin-top:2px;color:#995010;font-weight:bold;font-size:16px;">
                  {? @item.name ?}
                </h5>
                <br/>
                <p><i class="fa fa-calendar-minus-o" aria-hidden="true" style="color:#995010;margin-right:5px;"></i>你已坚持：{? @item.accumDays ?}天
                <p><i class="fa fa-asterisk" aria-hidden="true" style="color:#995010;margin-right:5px;"></i>今日得米：{? @item.freeMily ?}粒
                <p><i class="fa fa-asterisk" aria-hidden="true" style="color:#995010;margin-right:5px;"></i>累积得米：{? @item.accumMily ?}粒
            </div>
            <div class="media-right">
                <span ms-if="@item.isFeedBack=='0'" class="button-wrap">
                    <button ms-click="@gonote" ms-attr="{noteurl:'#!/main/grain/feednote/',postid:@item.postid,acid:@item.aid,habitid:@item.id,pid:@currentUserId,hid:@item.hid,isFeed:'0',class:'button button-glow button-circle button-action button-jumbo'}" style="background:#995010;">
                      <span  style="color:#fff;font-weight:bold;">
                         <span class="glyphicon glyphicon-hand-up" aria-hidden="true"></span>
                      </span>
                   </button>
               </span>
               <span ms-if="@item.isFeedBack=='1'" class="button-wrap">
                   <button ms-click="@gonote" ms-attr="{noteurl:'#!/main/grain/feednote/',postid:@item.postid,acid:@item.aid,habitid:@item.id,pid:@currentUserId,hid:@item.hid,isFeed:'1',class:'button button-glow button-circle button-action button-jumbo'}" style="background:#995010;">
                     <span>
                       <i    class="fa fa-check fa-fw"></i>
                     </span>
                  </button>
              </span>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <div class="modal fade"  id="shareN" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" >
          <div class="modal-dialog" role="document" style="background:0 none;">
              <div class="modal-content" style="width:100%;margin:0;background:rgba(0,0,0,.75);position:relative;z-index:9999;">
                <div class="modal-body" style="background:0 none;">
                  <a id="shareNKnow" class="close" style="display:block;width:30px;height:30px;position:absolute;top:10px;right:10px;z-index:99999;opacity:1;"><img src="/static/front/img/close_hov.png" width="30"/></a>
                  <div class="content" id="content" style="margin-top:-20px;">
                      <div class="row" style="margin:0;">
                             <img src="/static/front/img/active_bg.png" width="300" style="display:block;margin:10px auto 30px;"/>
                             <div style="position:absolute;top:70px;">
                                 <div class="col-xs-12 text-center">
                                      <img ms-attr="{src:@myinfo.headingImgUrl}"  class="img-circle" style="width:40px;height:40px"/><br/>
                                      <span style="font-size:16px;font-weight:bold;color:#995010;">{? @myinfo.nickName ?}</span>
                                 </div>
                                 <div class="col-xs-12 text-center">
                                     <span style="color:#466f25;padding-right:10px;">{? @myinfo.habitname ?}</span><span style="color:#466f25;">坚持了第{? @myinfo.accumDays ?}天</span>
                                 </div>
                                 <div class="col-xs-12 text-center">
                                     <span style="color:#995010;padding-right:10px;">今日获得米粒{? @myinfo.freeMily ?}粒</span><span style="color:#995010;">累积获得米粒{? @myinfo.accumMily ?}粒</span>
                                 </div>
                             </div>
                            <div class="col-xs-12 text-center" style="position:absolute;top:190px;left:0;">
                                <div>
                                    <img class="img-thumbnail" style="width:60%;height:150px;" ms-attr="{src:'/static/front/img/adv1.png'}" />
                                </div>
                             </div>
                             <!-- <div class="col-xs-12 text-center" style="margin-top:5px;margin-bottom:5px">
                                 <div>
                                   <img class="img-thumbnail" style="width:50%;height:170px" ms-attr="{src:'/static/front/img/codeimg.jpg'}"/>
                                </div>
                             </div> -->
                      </div>
                      <div style="text-align:center;margin-top:-20px;">
                          <a href="javascript:;" style="color:red;">点击右上角三点，分享您的荣耀到班级群</a>
                      </div>
                  </div>
              </div>
           </div>
        </div>
    </div>
  </div>
  <div class="modal fade" id="dlgCancelFeed" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel"><i class="fa fa-warning" style="color:orange"></i>取消打卡警告</h4>
        </div>
        <div class="modal-body" style="padding:20px">
          　<p>您确定要取消今日打卡吗？
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="button"　 id="cancelFeedOk" class="btn btn-success">确定</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="rptAct" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-body">
                  <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel"><i class="fa fa-smile-o" style="color:orange"></i>小小提示</h4>
                  </div>
                  <div class="text-center" style="width:100%;height:120px;margin-top:15px">
                      <div class="text-center">
                        <span>
                          点下方菜单"首页"，活动报名后才可以打卡！</span>
                      </div>
                      <div style="margin-top:15px;">
                        <button href="#" class="button button-pill  button-action" id="rptActKnow">我知道了</button>
                      </div>
                  </div>
              </div>
            </div>
      </div>
  </div>

  <script>
  $yml.page=$yml.pageBase.New(null,{
    ctor:function(){
      console.log("feedback loaded..."+this.getVmEleName());
      //基类里在pageReady方法里和可以访问成员$vmPage和$router
      //this.$vmPage
      //this.$router
    },
    vmDef:function(){
      return {
        $id:"feedback",
        currentUserId:null,
        $currentPostid:-1,
        myinfo:{},
        habits:[],
        backClick:function(){
          //$yml.page.$router.pop();
        },
        cleanUp:function(toCleanVm){
          this.habits.clear();
          this.currentUserId=null;
          avalon.router.localStorage.setItem("pub",0);//打卡设置发布为假
        },

        gonote:function(ev){
          //判断是否
          var $target=$(ev.currentTarget);
          var isfeed=$target.attr("isFeed")
          if(isfeed=='1'){
            //如果已经反馈，弹出取消反馈窗口，进行取消打卡调用
            $yml.page.$vmPage.$currentPostid=$target.attr("postid");
            $("#dlgCancelFeed").modal("show");
          }else{
            var params={}
            params.habitid=$target.attr("habitid");
            params.pid=$target.attr("pid");
            params.hid=$target.attr("hid");
            actid=$target.attr("acid");
            // name=$target.attr("nm");
            //缓存下来pid,hid,actid
            avalon.router.localStorage.setItem("pub",0);//打卡设置发布为假

            avalon.router.localStorage.setItem("pid",params.pid);
            // avalon.router.localStorage.setItem("name",name);
            avalon.router.localStorage.setItem("hid",params.habitid);
            avalon.router.localStorage.setItem("actid",actid);

            //创建反馈对象feedback,并生成一个默认贴,奖励米粒,如果参与了懒人基金，返还押金
            $yml.ajax('/api/grain/feedback/create',params,function(rtnData){
                if(rtnData.status==0){
                    $yml.page.$vmPage.habits.forEach(function(item){
                      if(item.id==rtnData.content.habitid){
                        item.isFeedBack="1"
                        item.postid=rtnData.content.postid
                        var gourl=$target.attr("noteurl")+item.postid
                        avalon.router.navigate(gourl,2)
                        return false;
                      }
                    })

                }else{
                  alert("发布出错");
                }
            });

          }
        }
      };
    },
    pageReady:function(params){
      var self=this;
      console.log(" feedback pageReady");
      $yml.dlgCenter("dlgCancelFeed");
      $yml.dlgCenter("rptAct");
      $yml.dlgCenter("shareN");
      //缓存当前打卡用户的id
      self.$vmPage.currentUserId=params.pid;
      //显示当前家庭的孩子参加活动所涉及的习惯列表
      $yml.ajax('/api/grain/feedback/habits',params,
      　  function(res){
            if(res.content.data.length==0){
              setTimeout(function(){
                $("#rptAct").modal("show")
                $("#rptActKnow").click(function(){
                  $("#rptAct").modal("hide")
                })
              },100)
            }
            $yml.page.$vmPage.habits.clear()
            res.content.data.forEach(function(r){
              $yml.page.$vmPage.habits.push(r)
            });
          }
      );
      $("#cancelFeedOk").click(function(){
        var params={}
        params.postid=$yml.page.$vmPage.$currentPostid;
        $yml.ajax('/api/grain/feedback/cancel',params,function(rtnData){
           $("#dlgCancelFeed").modal("hide");
            if(rtnData.status==0){
                avalon.router.localStorage.setItem("pub",0);//打卡设置发布为假
                habitid=rtnData.content.habitid;
                $yml.page.$vmPage.habits.forEach(function(item){
                  if(item.id==habitid){
                    item.isFeedBack="0"
                    item.postid=-1
                  }
                })
            }else{
              alert("取消打卡失败");
            }
        });
      });

      //弹出分享提示
      if(avalon.router.localStorage.getItem("pub")==1){
          //调用分享接口构造url
          var actid=avalon.router.localStorage.getItem("actid");
          var pid=avalon.router.localStorage.getItem("pid");
          var hid=avalon.router.localStorage.getItem("hid");
          // var name=avalon.router.localStorage.getItem("name");
          setTimeout(function(){
            var params={}
            params.actid=actid
            params.pid=pid
            params.habitid=hid
            $yml.ajax('/api/share/feedback',params,
            　  function(res){
                  $yml.page.$vmPage.myinfo=res.content;
                  $("#shareN").modal("show");
                  var url="http://mily365.com/share/"+actid+"/"+pid+"/"+hid
                  self.$vmMain.wxinit(url,document.location.href,+actid+"的荣耀分享","点击查看打卡分享")
                }
            );
            $("#shareNKnow").click(function(){
              $("#shareN").modal("hide")
              avalon.router.localStorage.setItem("pub",0);//打卡设置发布为假
              
            })
          },100)

      }
    }
  });
  </script>
